name: Sync GitHub to ClickUp


on:
  issues:
    types: [opened, closed, reopened, edited]
  pull_request:
    types: [opened, closed, reopened, ready_for_review, synchronize]


jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Sync to ClickUp
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
          CLICKUP_LIST_ID: ${{ secrets.CLICKUP_LIST_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_EVENT: ${{ toJson(github.event) }}
          EVENT_NAME: ${{ github.event_name }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          python - <<'EOF'
          import os
          import json
          import requests
          import re


          # Configuration
          CLICKUP_API_TOKEN = os.environ['CLICKUP_API_TOKEN']
          CLICKUP_LIST_ID = os.environ['CLICKUP_LIST_ID']
          GITHUB_TOKEN = os.environ['GITHUB_TOKEN']
          event = json.loads(os.environ['GITHUB_EVENT'])
          event_name = os.environ['EVENT_NAME']
          repo_owner = os.environ['REPO_OWNER']
          repo_name = os.environ['REPO_NAME']


          clickup_headers = {
              'Authorization': CLICKUP_API_TOKEN,
              'Content-Type': 'application/json'
          }
          
          github_headers = {
              'Authorization': f'Bearer {GITHUB_TOKEN}',
              'Accept': 'application/vnd.github+json',
              'X-GitHub-Api-Version': '2022-11-28'
          }


          def find_task_by_issue_number(issue_number):
              """Search for existing ClickUp task by issue number"""
              url = f"https://api.clickup.com/api/v2/list/{CLICKUP_LIST_ID}/task"
              params = {'subtasks': 'true', 'include_closed': 'true'}
              
              try:
                  response = requests.get(url, headers=clickup_headers, params=params)
                  response.raise_for_status()
                  
                  tasks = response.json().get('tasks', [])
                  for task in tasks:
                      task_name = task.get('name', '')
                      if f"[Issue #{issue_number}]" in task_name:
                          print(f"Found existing task: {task['id']} for issue #{issue_number}")
                          return task['id']
              except Exception as e:
                  print(f"Error searching for task: {e}")
              
              return None


          def find_parent_issue(issue_number):
              """Search all issues in repo to find if this issue is a child of another"""
              search_url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/issues"
              params = {'state': 'all', 'per_page': 100}
              
              try:
                  response = requests.get(search_url, headers=github_headers, params=params)
                  response.raise_for_status()
                  all_issues = response.json()
                  
                  # Look through all issues to see if any reference this issue as a subtask
                  for potential_parent in all_issues:
                      if 'pull_request' in potential_parent:
                          continue  # Skip PRs
                      
                      body = potential_parent.get('body', '')
                      if not body:
                          continue
                      
                      # Check if this issue is listed as a subtask in the parent's body
                      # Format: "- [ ] #123" or "- [x] #123"
                      pattern = rf'\s*-\s*\[[ xX]\]\s*#{issue_number}\b'
                      if re.search(pattern, body):
                          parent_number = potential_parent['number']
                          print(f"Found parent issue #{parent_number} for issue #{issue_number}")
                          return parent_number
                  
                  print(f"No parent issue found for #{issue_number}")
                  return None
                  
              except Exception as e:
                  print(f"Error searching for parent issue: {e}")
                  return None


          def get_github_issue_data(issue_number):
              """Fetch issue data from GitHub including relationships"""
              url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/issues/{issue_number}"
              
              try:
                  response = requests.get(url, headers=github_headers)
                  response.raise_for_status()
                  issue_data = response.json()
                  
                  # Parse body for sub-issues and blocked_by
                  body = issue_data.get('body', '')
                  
                  # Look for GitHub's sub-issue syntax in body
                  # Format: "- [ ] #123" or "- [x] #123" in task lists
                  sub_issues = []
                  for line in body.split('\n'):
                      # Match task list items with issue references
                      match = re.match(r'\s*-\s*\[[ xX]\]\s*#(\d+)', line)
                      if match:
                          sub_issues.append(int(match.group(1)))
                  
                  # Look for "Blocked by #X" pattern
                  blocked_by = []
                  blocked_pattern = r'(?:blocked?\s+by|depends?\s+on|waiting\s+on)\s*#(\d+)'
                  blocked_matches = re.findall(blocked_pattern, body, re.IGNORECASE)
                  blocked_by = [int(num) for num in blocked_matches]
                  
                  return {
                      'sub_issues': sub_issues,
                      'blocked_by': blocked_by
                  }
              except Exception as e:
                  print(f"Error fetching issue data: {e}")
                  return {'sub_issues': [], 'blocked_by': []}


          def add_comment_to_task(task_id, comment_text):
              """Add a comment to a ClickUp task"""
              url = f"https://api.clickup.com/api/v2/task/{task_id}/comment"
              data = {'comment_text': comment_text}
              
              try:
                  response = requests.post(url, json=data, headers=clickup_headers)
                  response.raise_for_status()
                  print(f"✓ Added comment to task {task_id}")
                  return True
              except Exception as e:
                  print(f"✗ Error adding comment: {e}")
                  return False


          def set_task_dependency(task_id, depends_on_task_id):
              """Set ClickUp task dependency (task_id blocked by depends_on_task_id)"""
              url = f"https://api.clickup.com/api/v2/task/{task_id}/dependency"
              params = {'depends_on': depends_on_task_id}
              
              try:
                  response = requests.post(url, params=params, headers=clickup_headers)
                  response.raise_for_status()
                  print(f"✓ Set dependency: Task {task_id} blocked by {depends_on_task_id}")
                  return True
              except Exception as e:
                  # Might already exist
                  if 'already exists' in str(e).lower():
                      print(f"  Dependency already exists")
                      return True
                  print(f"✗ Error setting dependency: {e}")
                  return False


          def create_or_update_subtask(parent_task_id, issue_number, title, body, url, status):
              """Create or update a ClickUp subtask under a parent task"""
              # Check if subtask already exists
              existing_task_id = find_task_by_issue_number(issue_number)
              
              # Escape quotes
              title_escaped = title.replace('"', '\"')
              body_escaped = (body or '').replace('"', '\"')
              
              task_data = {
                  'name': f"[Issue #{issue_number}] {title_escaped}",
                  'description': f"GitHub Issue: {url}\n\n{body_escaped}",
                  'status': status,
                  'parent': parent_task_id
              }
              
              if existing_task_id:
                  # Update existing task and ensure it's a subtask of the parent
                  update_url = f"https://api.clickup.com/api/v2/task/{existing_task_id}"
                  try:
                      response = requests.put(update_url, json=task_data, headers=clickup_headers)
                      response.raise_for_status()
                      print(f"✓ Updated subtask {existing_task_id} for issue #{issue_number} under parent {parent_task_id}")
                      return existing_task_id
                  except Exception as e:
                      print(f"✗ Error updating subtask: {e}")
                      return None
              else:
                  # Create new subtask with parent relationship
                  task_data['tags'] = ['github-sub-issue']
                  
                  create_url = f"https://api.clickup.com/api/v2/list/{CLICKUP_LIST_ID}/task"
                  try:
                      response = requests.post(create_url, json=task_data, headers=clickup_headers)
                      response.raise_for_status()
                      new_task_id = response.json()['id']
                      print(f"✓ Created subtask {new_task_id} for issue #{issue_number} under parent {parent_task_id}")
                      return new_task_id
                  except Exception as e:
                      print(f"✗ Error creating subtask: {e}")
                      print(f"   Response: {response.text if 'response' in locals() else 'N/A'}")
                      return None


          def create_or_update_task(issue_number, title, body, url, status):
              """Create or update ClickUp task (parent-level task)"""
              task_id = find_task_by_issue_number(issue_number)
              
              # Escape quotes
              title_escaped = title.replace('"', '\"')
              body_escaped = (body or '').replace('"', '\"')
              
              task_data = {
                  'name': f"[Issue #{issue_number}] {title_escaped}",
                  'description': f"GitHub Issue: {url}\n\n{body_escaped}",
                  'status': status
              }
              
              if task_id:
                  # Update existing task
                  update_url = f"https://api.clickup.com/api/v2/task/{task_id}"
                  try:
                      response = requests.put(update_url, json=task_data, headers=clickup_headers)
                      response.raise_for_status()
                      print(f"✓ Updated task {task_id} for issue #{issue_number} - Status: {status}")
                      return task_id
                  except Exception as e:
                      print(f"✗ Error updating task: {e}")
              else:
                  # Create new task
                  task_data['tags'] = ['github-issue']
                  create_url = f"https://api.clickup.com/api/v2/list/{CLICKUP_LIST_ID}/task"
                  try:
                      response = requests.post(create_url, json=task_data, headers=clickup_headers)
                      response.raise_for_status()
                      new_task_id = response.json()['id']
                      print(f"✓ Created task {new_task_id} for issue #{issue_number} - Status: {status}")
                      return new_task_id
                  except Exception as e:
                      print(f"✗ Error creating task: {e}")
              
              return None


          def get_pr_commits(pr_number):
              """Fetch commits from a PR"""
              url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/pulls/{pr_number}/commits"
              
              try:
                  response = requests.get(url, headers=github_headers)
                  response.raise_for_status()
                  return response.json()
              except Exception as e:
                  print(f"✗ Error fetching commits: {e}")
                  return []


          def extract_issue_numbers(text):
              """Extract issue numbers from PR body/title"""
              if not text:
                  return []
              
              pattern = r'(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*#(\d+)|#(\d+)'
              matches = re.findall(pattern, text, re.IGNORECASE)
              issue_numbers = [num for match in matches for num in match if num]
              return list(set(issue_numbers))


          # Main logic
          print(f"Event: {event_name}")


          # Handle issue events
          if event_name == 'issues':
              issue = event['issue']
              issue_number = issue['number']
              title = issue['title']
              body = issue.get('body', '')
              url = issue['html_url']
              state = issue['state']
              
              # CRITICAL: Check if this issue is a child of another issue
              print(f"Checking if issue #{issue_number} is a child of another issue...")
              parent_issue_number = find_parent_issue(issue_number)
              
              # Parse issue body for its own children and blocked_by
              print(f"Parsing relationships for issue #{issue_number}...")
              relationships = get_github_issue_data(issue_number)
              sub_issues = relationships['sub_issues']
              blocked_by_issues = relationships['blocked_by']
              
              print(f"  Is child of: {parent_issue_number if parent_issue_number else 'None'}")
              print(f"  Has children: {sub_issues}")
              print(f"  Blocked by: {blocked_by_issues}")
              
              # Determine status
              if state == 'closed':
                  status = 'done'
              elif blocked_by_issues:
                  status = 'blocked'
              else:
                  status = 'todo'
              
              # If this issue is a child, create it as a subtask
              if parent_issue_number:
                  parent_task_id = find_task_by_issue_number(parent_issue_number)
                  if parent_task_id:
                      print(f"Creating/updating issue #{issue_number} as subtask of #{parent_issue_number}")
                      task_id = create_or_update_subtask(
                          parent_task_id,
                          issue_number,
                          title,
                          body,
                          url,
                          status
                      )
                  else:
                      print(f"⚠ Parent issue #{parent_issue_number} not found in ClickUp - creating as top-level task")
                      task_id = create_or_update_task(issue_number, title, body, url, status)
              else:
                  # Create as top-level task
                  print(f"Creating/updating issue #{issue_number} as top-level task")
                  task_id = create_or_update_task(issue_number, title, body, url, status)
              
              if task_id:
                  # Create ClickUp subtasks for this issue's children
                  if sub_issues:
                      print(f"Processing {len(sub_issues)} child issues...")
                      for sub_issue_num in sub_issues:
                          # Fetch sub-issue details from GitHub
                          sub_url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/issues/{sub_issue_num}"
                          try:
                              sub_response = requests.get(sub_url, headers=github_headers)
                              sub_response.raise_for_status()
                              sub_issue = sub_response.json()
                              
                              sub_status = 'done' if sub_issue['state'] == 'closed' else 'todo'
                              create_or_update_subtask(
                                  task_id,
                                  sub_issue_num,
                                  sub_issue['title'],
                                  sub_issue.get('body', ''),
                                  sub_issue['html_url'],
                                  sub_status
                              )
                          except Exception as e:
                              print(f"✗ Error processing sub-issue #{sub_issue_num}: {e}")
                  
                  # Set ClickUp dependencies for blocked_by relationships
                  if blocked_by_issues:
                      print(f"Setting {len(blocked_by_issues)} dependencies...")
                      for blocking_issue_num in blocked_by_issues:
                          blocking_task_id = find_task_by_issue_number(blocking_issue_num)
                          if blocking_task_id:
                              set_task_dependency(task_id, blocking_task_id)
                              add_comment_to_task(
                                  task_id,
                                  f"Blocked by Issue #{blocking_issue_num}"
                              )
                          else:
                              print(f"⚠ Blocking issue #{blocking_issue_num} not found in ClickUp")


          # Handle PR events
          elif event_name == 'pull_request':
              pr = event['pull_request']
              pr_number = pr['number']
              pr_url = pr['html_url']
              pr_state = pr['state']
              pr_merged = pr.get('merged', False)
              pr_draft = pr.get('draft', False)
              
              # Extract linked issues
              pr_body = pr.get('body', '')
              pr_title = pr['title']
              issue_numbers = extract_issue_numbers(f"{pr_title} {pr_body}")
              
              # Determine status
              if pr_merged:
                  status = 'done'
              elif pr_state == 'closed':
                  status = 'done'
              elif pr_state == 'open' and not pr_draft:
                  status = 'in progress'
              else:
                  status = 'todo'
              
              print(f"PR #{pr_number} ({pr_state}, merged={pr_merged})")
              print(f"Found linked issues: {issue_numbers}")
              
              if not issue_numbers:
                  print("No linked issues found")
              
              # Get commits
              commits = get_pr_commits(pr_number)
              commit_summary = ""
              if commits:
                  commit_summary = f"\n\nRecent commits:\n"
                  for commit in commits[-5:]:
                      commit_msg = commit['commit']['message'].split('\n')[0]
                      commit_sha = commit['sha'][:7]
                      commit_url = commit['html_url']
                      commit_author = commit['commit']['author']['name']
                      commit_summary += f"- [`{commit_sha}`]({commit_url}) {commit_msg} - {commit_author}\n"
              
              # Update linked issues
              for issue_num in issue_numbers:
                  task_id = find_task_by_issue_number(int(issue_num))
                  
                  if task_id:
                      try:
                          task_url = f"https://api.clickup.com/api/v2/task/{task_id}"
                          task_response = requests.get(task_url, headers=clickup_headers)
                          task_response.raise_for_status()
                          
                          task = task_response.json()
                          current_desc = task.get('description', '')
                          current_status = task.get('status', {}).get('status', '')
                          
                          # Don't override blocked status
                          if current_status == 'blocked' and status == 'in progress':
                              final_status = 'blocked'
                          else:
                              final_status = status
                          
                          # Add PR link
                          if pr_url not in current_desc:
                              new_desc = f"{current_desc}\n\nAssociated PR: {pr_url}"
                          else:
                              new_desc = current_desc
                          
                          # Update task
                          update_data = {
                              'description': new_desc,
                              'status': final_status
                          }
                          
                          requests.put(task_url, json=update_data, headers=clickup_headers)
                          print(f"✓ Updated task {task_id} - Status: {final_status}")
                          
                          # Add comment
                          action = event.get('action', '')
                          comment_text = f"PR #{pr_number} {action}: {pr_url}\n\nStatus: `{final_status}`{commit_summary}"
                          add_comment_to_task(task_id, comment_text)
                          
                      except Exception as e:
                          print(f"✗ Error updating task: {e}")
          
          print("Sync complete!")
          EOF
