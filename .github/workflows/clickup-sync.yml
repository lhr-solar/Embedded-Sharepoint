name: Sync GitHub to ClickUp

on:
  issues:
    types: [opened, closed, reopened, edited]
  pull_request:
    types: [opened, closed, reopened, ready_for_review, synchronize]

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: pip install requests
      
      - name: Sync to ClickUp
        env:
          CLICKUP_API_TOKEN: ${{ secrets.CLICKUP_API_TOKEN }}
          CLICKUP_LIST_ID: ${{ secrets.CLICKUP_LIST_ID }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_EVENT: ${{ toJson(github.event) }}
          EVENT_NAME: ${{ github.event_name }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          python - <<'EOF'
          import os
          import json
          import requests
          import re

          # Configuration
          CLICKUP_API_TOKEN = os.environ['CLICKUP_API_TOKEN']
          CLICKUP_LIST_ID = os.environ['CLICKUP_LIST_ID']
          GITHUB_TOKEN = os.environ['GITHUB_TOKEN']
          event = json.loads(os.environ['GITHUB_EVENT'])
          event_name = os.environ['EVENT_NAME']
          repo_owner = os.environ['REPO_OWNER']
          repo_name = os.environ['REPO_NAME']

          clickup_headers = {
              'Authorization': CLICKUP_API_TOKEN,
              'Content-Type': 'application/json'
          }
          
          github_headers = {
              'Authorization': f'Bearer {GITHUB_TOKEN}',
              'Accept': 'application/vnd.github+json',
              'X-GitHub-Api-Version': '2022-11-28'
          }

          def find_task_by_issue_number(issue_number):
              """Search for existing ClickUp task by issue number"""
              url = f"https://api.clickup.com/api/v2/list/{CLICKUP_LIST_ID}/task"
              params = {'subtasks': 'true', 'include_closed': 'true'}
              
              try:
                  response = requests.get(url, headers=clickup_headers, params=params)
                  response.raise_for_status()
                  
                  tasks = response.json().get('tasks', [])
                  for task in tasks:
                      task_name = task.get('name', '')
                      if f"[Issue #{issue_number}]" in task_name:
                          print(f"Found existing task: {task['id']} for issue #{issue_number}")
                          return task['id']
              except Exception as e:
                  print(f"Error searching for task: {e}")
              
              return None

          def get_github_sub_issues(issue_number):
              """Fetch sub-issues from GitHub using timeline API"""
              url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/issues/{issue_number}/timeline"
              
              try:
                  response = requests.get(url, headers=github_headers)
                  response.raise_for_status()
                  timeline = response.json()
                  
                  sub_issues = []
                  for event in timeline:
                      if event.get('event') == 'child_issue_added':
                          child_issue = event.get('child_issue', {})
                          sub_issues.append(child_issue.get('number'))
                  
                  return sub_issues
              except Exception as e:
                  print(f"Error fetching sub-issues: {e}")
                  return []

          def get_github_blocked_by(issue_number):
              """Fetch 'blocked by' dependencies from GitHub"""
              url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/issues/{issue_number}/dependencies/blocked_by"
              
              try:
                  response = requests.get(url, headers=github_headers)
                  response.raise_for_status()
                  dependencies = response.json()
                  
                  blocked_by_issues = []
                  for dep in dependencies:
                      blocked_by_issues.append(dep.get('number'))
                  
                  return blocked_by_issues
              except Exception as e:
                  print(f"Error fetching blocked_by dependencies: {e}")
                  return []

          def add_comment_to_task(task_id, comment_text):
              """Add a comment to a ClickUp task"""
              url = f"https://api.clickup.com/api/v2/task/{task_id}/comment"
              data = {'comment_text': comment_text}
              
              try:
                  response = requests.post(url, json=data, headers=clickup_headers)
                  response.raise_for_status()
                  print(f"✓ Added comment to task {task_id}")
                  return True
              except Exception as e:
                  print(f"✗ Error adding comment: {e}")
                  return False

          def set_task_dependency(task_id, depends_on_task_id):
              """Set ClickUp task dependency (task_id blocked by depends_on_task_id)"""
              url = f"https://api.clickup.com/api/v2/task/{task_id}/dependency"
              params = {'depends_on': depends_on_task_id}
              
              try:
                  response = requests.post(url, params=params, headers=clickup_headers)
                  response.raise_for_status()
                  print(f"✓ Set dependency: Task {task_id} blocked by {depends_on_task_id}")
                  return True
              except Exception as e:
                  print(f"✗ Error setting dependency: {e}")
                  return False

          def create_subtask(parent_task_id, issue_number, title, body, url, status):
              """Create a ClickUp subtask"""
              # Escape quotes
              title = title.replace('"', '\"')
              body = (body or '').replace('"', '\"')
              
              task_data = {
                  'name': f"[Issue #{issue_number}] {title}",
                  'description': f"GitHub Issue: {url}\n\n{body}",
                  'status': status,
                  'parent': parent_task_id
              }
              
              create_url = f"https://api.clickup.com/api/v2/list/{CLICKUP_LIST_ID}/task"
              try:
                  response = requests.post(create_url, json=task_data, headers=clickup_headers)
                  response.raise_for_status()
                  new_task_id = response.json()['id']
                  print(f"✓ Created subtask {new_task_id} for issue #{issue_number}")
                  return new_task_id
              except Exception as e:
                  print(f"✗ Error creating subtask: {e}")
                  return None

          def create_or_update_task(issue_number, title, body, url, status):
              """Create or update ClickUp task"""
              task_id = find_task_by_issue_number(issue_number)
              
              # Escape quotes
              title = title.replace('"', '\"')
              body_escaped = (body or '').replace('"', '\"')
              
              task_data = {
                  'name': f"[Issue #{issue_number}] {title}",
                  'description': f"GitHub Issue: {url}\n\n{body_escaped}",
                  'status': status
              }
              
              if task_id:
                  # Update existing task
                  update_url = f"https://api.clickup.com/api/v2/task/{task_id}"
                  try:
                      response = requests.put(update_url, json=task_data, headers=clickup_headers)
                      response.raise_for_status()
                      print(f"✓ Updated task {task_id} for issue #{issue_number} - Status: {status}")
                      return task_id
                  except Exception as e:
                      print(f"✗ Error updating task: {e}")
              else:
                  # Create new task
                  task_data['tags'] = ['github-issue']
                  create_url = f"https://api.clickup.com/api/v2/list/{CLICKUP_LIST_ID}/task"
                  try:
                      response = requests.post(create_url, json=task_data, headers=clickup_headers)
                      response.raise_for_status()
                      new_task_id = response.json()['id']
                      print(f"✓ Created task {new_task_id} for issue #{issue_number} - Status: {status}")
                      return new_task_id
                  except Exception as e:
                      print(f"✗ Error creating task: {e}")
              
              return None

          def get_pr_commits(pr_number):
              """Fetch commits from a PR"""
              url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/pulls/{pr_number}/commits"
              
              try:
                  response = requests.get(url, headers=github_headers)
                  response.raise_for_status()
                  return response.json()
              except Exception as e:
                  print(f"✗ Error fetching commits: {e}")
                  return []

          def extract_issue_numbers(text):
              """Extract issue numbers from PR body/title"""
              if not text:
                  return []
              
              pattern = r'(?:close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*#(\d+)|#(\d+)'
              matches = re.findall(pattern, text, re.IGNORECASE)
              issue_numbers = [num for match in matches for num in match if num]
              return list(set(issue_numbers))

          # Main logic
          print(f"Event: {event_name}")

          # Handle issue events
          if event_name == 'issues':
              issue = event['issue']
              issue_number = issue['number']
              title = issue['title']
              body = issue.get('body', '')
              url = issue['html_url']
              state = issue['state']
              
              # Fetch GitHub relationships
              print(f"Fetching relationships for issue #{issue_number}...")
              sub_issues = get_github_sub_issues(issue_number)
              blocked_by_issues = get_github_blocked_by(issue_number)
              
              print(f"Sub-issues: {sub_issues}")
              print(f"Blocked by: {blocked_by_issues}")
              
              # Determine status
              if state == 'closed':
                  status = 'done'
              elif blocked_by_issues:
                  status = 'blocked'
              else:
                  status = 'todo'
              
              print(f"Processing issue #{issue_number}: {title}")
              task_id = create_or_update_task(issue_number, title, body, url, status)
              
              if task_id:
                  # Create ClickUp subtasks for GitHub sub-issues
                  if sub_issues:
                      print(f"Creating {len(sub_issues)} subtasks...")
                      for sub_issue_num in sub_issues:
                          # Fetch sub-issue details
                          sub_url = f"https://api.github.com/repos/{repo_owner}/{repo_name}/issues/{sub_issue_num}"
                          try:
                              sub_response = requests.get(sub_url, headers=github_headers)
                              sub_response.raise_for_status()
                              sub_issue = sub_response.json()
                              
                              sub_status = 'done' if sub_issue['state'] == 'closed' else 'todo'
                              create_subtask(
                                  task_id,
                                  sub_issue_num,
                                  sub_issue['title'],
                                  sub_issue.get('body', ''),
                                  sub_issue['html_url'],
                                  sub_status
                              )
                          except Exception as e:
                              print(f"✗ Error fetching sub-issue #{sub_issue_num}: {e}")
                  
                  # Set ClickUp dependencies for blocked_by relationships
                  if blocked_by_issues:
                      print(f"Setting {len(blocked_by_issues)} dependencies...")
                      for blocking_issue_num in blocked_by_issues:
                          blocking_task_id = find_task_by_issue_number(blocking_issue_num)
                          if blocking_task_id:
                              set_task_dependency(task_id, blocking_task_id)
                              add_comment_to_task(
                                  task_id,
                                  f"Blocked by Issue #{blocking_issue_num}"
                              )
                          else:
                              print(f"⚠ Blocking issue #{blocking_issue_num} not found in ClickUp")

          # Handle PR events
          elif event_name == 'pull_request':
              pr = event['pull_request']
              pr_number = pr['number']
              pr_url = pr['html_url']
              pr_state = pr['state']
              pr_merged = pr.get('merged', False)
              pr_draft = pr.get('draft', False)
              
              # Extract linked issues
              pr_body = pr.get('body', '')
              pr_title = pr['title']
              issue_numbers = extract_issue_numbers(f"{pr_title} {pr_body}")
              
              # Determine status
              if pr_merged:
                  status = 'done'
              elif pr_state == 'closed':
                  status = 'done'
              elif pr_state == 'open' and not pr_draft:
                  status = 'in progress'
              else:
                  status = 'todo'
              
              print(f"PR #{pr_number} ({pr_state}, merged={pr_merged})")
              print(f"Found linked issues: {issue_numbers}")
              
              if not issue_numbers:
                  print("No linked issues found in PR")
              
              # Get commits
              commits = get_pr_commits(pr_number)
              commit_summary = ""
              if commits:
                  commit_summary = f"\n\nRecent commits:\n"
                  for commit in commits[-3:]:
                      commit_msg = commit['commit']['message'].split('\n')[0]
                      commit_sha = commit['sha'][:7]
                      commit_url = commit['html_url']
                      commit_author = commit['commit']['author']['name']
                      commit_summary += f"- [`{commit_sha}`]({commit_url}) {commit_msg} - {commit_author}\n"
              
              # Update linked issues
              for issue_num in issue_numbers:
                  task_id = find_task_by_issue_number(int(issue_num))
                  
                  if task_id:
                      try:
                          task_url = f"https://api.clickup.com/api/v2/task/{task_id}"
                          task_response = requests.get(task_url, headers=clickup_headers)
                          task_response.raise_for_status()
                          
                          task = task_response.json()
                          current_desc = task.get('description', '')
                          current_status = task.get('status', {}).get('status', '')
                          
                          # Don't override blocked status
                          if current_status == 'blocked' and status == 'in progress':
                              final_status = 'blocked'
                          else:
                              final_status = status
                          
                          # Add PR link
                          if pr_url not in current_desc:
                              new_desc = f"{current_desc}\n\nAssociated PR: {pr_url}"
                          else:
                              new_desc = current_desc
                          
                          # Update task
                          update_data = {
                              'description': new_desc,
                              'status': final_status
                          }
                          
                          requests.put(task_url, json=update_data, headers=clickup_headers)
                          print(f"✓ Updated task {task_id} - Status: {final_status}")
                          
                          # Add comment
                          action = event.get('action', '')
                          comment_text = f"PR #{pr_number} {action}: {pr_url}\n\nStatus: `{final_status}`{commit_summary}"
                          add_comment_to_task(task_id, comment_text)
                          
                      except Exception as e:
                          print(f"✗ Error updating task: {e}")
          
          print("Sync complete!")
          EOF
