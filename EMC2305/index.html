
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Software library shared among LHRS embedded systems">
      
      
        <meta name="author" content="LHR - Solar">
      
      
      
        <link rel="prev" href="../DBC/">
      
      
      
        
      
      
      <link rel="icon" href="../LHRs.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>EMC2305 Fan Controller - Embedded Sharepoint Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#emc2305-pwm-fan-controller-driver-documentation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Embedded Sharepoint Documentation" class="md-header__button md-logo" aria-label="Embedded Sharepoint Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Embedded Sharepoint Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              EMC2305 Fan Controller
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Embedded Sharepoint Documentation" class="md-nav__button md-logo" aria-label="Embedded Sharepoint Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Embedded Sharepoint Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../FlashAndTheBug/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flashing and Debugging
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../SharepointSubmodule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Adding Embedded Sharepoint
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../CubeMX/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CubeMX
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../STM32_Ports/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    STM32 Ports
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    CAN Messages
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    CAN Messages
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../DBC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Signals & Messages
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Drivers
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Drivers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    EMC2305 Fan Controller
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    EMC2305 Fan Controller
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#minimal-working-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Minimal Working Example
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#required-hardware-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Required Hardware Setup
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Required Hardware Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mcu-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        MCU Requirements
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fan-electrical-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fan Electrical Requirements
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialization-process-required-order" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialization Process (Required Order)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Initialization Process (Required Order)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-hal-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Required HAL Callbacks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#driver-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Driver Initialization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-configuration-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Configuration Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Configuration Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#global-chip-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Global Chip Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#software-lock-optional" class="md-nav__link">
    <span class="md-ellipsis">
      
        Software Lock (Optional)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operating-modes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Operating Modes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operating Modes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#openloop-pwm-mode-simple" class="md-nav__link">
    <span class="md-ellipsis">
      
        Open‑Loop PWM Mode (Simple)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#closedloop-rpm-control-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      
        Closed‑Loop RPM Control (Recommended)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fan-control-api-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fan Control API Summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-pitfalls" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Pitfalls
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Pitfalls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-apis-before-rtos-starts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using APIs Before RTOS Starts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#missing-hal-i2c-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Missing HAL I2C Callbacks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#queue-semaphore-exhaustion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Queue / Semaphore Exhaustion
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wrong-control-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Wrong Control Mode
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging-guide" class="md-nav__link">
    <span class="md-ellipsis">
      
        Debugging Guide
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debugging Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chip-not-detected" class="md-nav__link">
    <span class="md-ellipsis">
      
        Chip Not Detected
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpm-always-reads-uint16_max" class="md-nav__link">
    <span class="md-ellipsis">
      
        RPM Always Reads UINT16_MAX
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fan-status-flags" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fan Status Flags
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#minimal-working-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Minimal Working Example
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#required-hardware-setup" class="md-nav__link">
    <span class="md-ellipsis">
      
        Required Hardware Setup
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Required Hardware Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mcu-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        MCU Requirements
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fan-electrical-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fan Electrical Requirements
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#initialization-process-required-order" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initialization Process (Required Order)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Initialization Process (Required Order)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-hal-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Required HAL Callbacks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#driver-initialization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Driver Initialization
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-configuration-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Configuration Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Configuration Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#global-chip-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Global Chip Configuration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#software-lock-optional" class="md-nav__link">
    <span class="md-ellipsis">
      
        Software Lock (Optional)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#operating-modes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Operating Modes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Operating Modes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#openloop-pwm-mode-simple" class="md-nav__link">
    <span class="md-ellipsis">
      
        Open‑Loop PWM Mode (Simple)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#closedloop-rpm-control-recommended" class="md-nav__link">
    <span class="md-ellipsis">
      
        Closed‑Loop RPM Control (Recommended)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fan-control-api-summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fan Control API Summary
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-pitfalls" class="md-nav__link">
    <span class="md-ellipsis">
      
        Common Pitfalls
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Common Pitfalls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-apis-before-rtos-starts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Using APIs Before RTOS Starts
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#missing-hal-i2c-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      
        Missing HAL I2C Callbacks
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#queue-semaphore-exhaustion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Queue / Semaphore Exhaustion
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#wrong-control-mode" class="md-nav__link">
    <span class="md-ellipsis">
      
        Wrong Control Mode
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging-guide" class="md-nav__link">
    <span class="md-ellipsis">
      
        Debugging Guide
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debugging Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#chip-not-detected" class="md-nav__link">
    <span class="md-ellipsis">
      
        Chip Not Detected
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rpm-always-reads-uint16_max" class="md-nav__link">
    <span class="md-ellipsis">
      
        RPM Always Reads UINT16_MAX
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fan-status-flags" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fan Status Flags
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="emc2305-pwm-fan-controller-driver-documentation">EMC2305 PWM Fan Controller Driver Documentation</h1>
<h2 id="overview">Overview</h2>
<p>The EMC2305 is a <strong>5‑channel PWM fan controller</strong> with optional <strong>closed‑loop RPM control</strong> using tachometer feedback. Driver functions must be called while the FreeRTOS scheduler is active.</p>
<hr />
<h2 id="minimal-working-example">Minimal Working Example</h2>
<p>WARNING. Don't just copy this code without reading the rest of this page. Lakshay Gupta takes all responsibility for incorrect information regarding this driver. Happy cooling :D</p>
<pre><code class="language-c">// Assuming I2C was initialized and interrupt callbacks overridden
// Reference 

#include &quot;EMC2305.h&quot;

I2C_HandleTypeDef hi2c1;
EMC2305_HandleTypeDef chip;

void Init_Task(void* argument) {
    // Initialize EMC2305
    // Only call from ONE task!
    if (EMC2305_Init(&amp;chip, &amp;hi2c1, 0x4D) != EMC2305_OK) {
        Error_Handler();
    }

    // Task kills itself
    vTaskDelete(NULL);
}

void EMC2305_Task_1(void* argument) {
    // Allow chip to power on
    vTaskDelay(pdMS_TO_TICKS(250));

    // Set global config
    EMC2305_Global_Config config = { 0 };
    config.watchdog_enable = true;

    if (EMC2305_SetGlobalConfig(&amp;chip, &amp;config) != EMC2305_OK) {
        Error_Handler();
    }

    // Set config1 and config2
    EMC2305_Fan_Config1 config1 = { 0 };
    config1.enable_closed_loop = false; // Set this to true if using FSC (Closed Loop RPM Control). False for using PWM directly
    config1.edges = EMC2305_EDG_5; // 5 edges is default for 2 pole fans
    config1.range = EMC2305_RNG_2000;

    EMC2305_Fan_Config2 config2 = { 0 };
    config2.enable_ramp_rate_ctl = true;
    config2.enable_glitch_filter = true;
    config2.error_window = EMC2305_ERG_200RPM;
    config2.derivative_options = EMC2305_DPT_BOTH;

    if (EMC2305_SetFanConfig(&amp;chip, EMC2305_FAN2, &amp;config1, &amp;config2) != EMC2305_OK) {
        Error_Handler();
    };

    // Depends on the fan lol (should be in fan datasheet)
    if (EMC2305_SetPWMBaseFrequency(&amp;chip, EMC2305_FAN2, EMC2305_PWM_19k53) != EMC2305_OK) {
        Error_Handler();
    };

    // Set minimum drive to 0%
    if (EMC2305_WriteReg(&amp;chip, EMC2305_FAN_REG_ADDR(EMC2305_FAN2, EMC2305_REG_FAN1_MIN_DRIVE), 0x00) != EMC2305_OK) {
        Error_Handler();
    };

    // Set PID Gain to lowest (1x)
    if (EMC2305_WriteReg(&amp;chip, EMC2305_FAN_REG_ADDR(EMC2305_FAN2, EMC2305_REG_GAIN1), 0x00) != EMC2305_OK) {
        Error_Handler();
    };

    // Set PWM output mode to open-drain (use false for push-pull)
    if (EMC2305_SetPWMOutputMode(&amp;chip, EMC2305_FAN2, true) != EMC2305_OK) {
        Error_Handler();
    };

    // Control with direct PWM
    // Set PWM2 duty cycle to 25%
    if (EMC2305_SetFanPWM(&amp;chip, EMC2305_FAN2, 25) != EMC2305_OK) {
        Error_Handler();
    };

    // Control with closed-loop FSC
    // Set RPM to 3000
    if (EMC2305_SetFanRPM(&amp;chip, EMC2305_FAN2, 3000) != EMC2305_OK) {
        Error_Handler();
    };
}

int main(void) {
    // Init your HAL, System Clock, and Peripherals here

    // Create tasks
    xTaskCreateStatic(Init_Task,
        &quot;Init Task&quot;,
        configMINIMAL_STACK_SIZE,
        NULL,
        tskIDLE_PRIORITY + 1,
        initTaskStack,
        &amp;initTaskBuffer);

    xTaskCreateStatic(EMC2305_Task_1,
        &quot;EMC2305 Task 1&quot;,
        configMINIMAL_STACK_SIZE,
        NULL,
        tskIDLE_PRIORITY + 2,
        emc2305TaskStack_1,
        &amp;emc2305TaskBuffer_1);

    vTaskStartScheduler();

    while (1) {
    }

    return 0;
}

// I2C Transmit Interrupt Callback
void HAL_I2C_MasterTxCpltCallback(I2C_HandleTypeDef* hi2c) {
    EMC2305_I2C_MasterTxCpltCallback(hi2c);
}

// I2C Receive Interrupt Callback
void HAL_I2C_MasterRxCpltCallback(I2C_HandleTypeDef* hi2c) {
    EMC2305_I2C_MasterTxCpltCallback(hi2c);
}
</code></pre>
<hr />
<h2 id="required-hardware-setup">Required Hardware Setup</h2>
<h3 id="mcu-requirements">MCU Requirements</h3>
<p>Your board must have:</p>
<ul>
<li>An STM32 MCU using <strong>STM32 HAL</strong> (PSOM, LSOM, or any of our other custom STM32 boards)</li>
<li>A configured <strong>I2C peripheral</strong> (interrupt‑driven)</li>
<li><strong>FreeRTOS enabled</strong> in your project (all Embedded-Sharepoint projects use RTOS by default)</li>
</ul>
<p>This driver <strong>relies on</strong>:</p>
<ul>
<li><code>HAL_I2C_Master_Transmit_IT()</code></li>
<li><code>HAL_I2C_Master_Receive_IT()</code></li>
<li>FreeRTOS queues, semaphores, and static task creation</li>
</ul>
<hr />
<h3 id="fan-electrical-requirements">Fan Electrical Requirements</h3>
<p>Fans may be controlled via:</p>
<ul>
<li><strong>Push‑pull PWM</strong> (driven to high and low logic levels)</li>
<li><strong>Open‑drain PWM</strong> (only driven low, requires an external pull‑up)</li>
</ul>
<p>This is configured per‑fan using:</p>
<pre><code class="language-c">EMC2305_SetPWMOutputMode()
</code></pre>
<hr />
<h2 id="initialization-process-required-order">Initialization Process (Required Order)</h2>
<h3 id="prerequisites">Prerequisites</h3>
<p>Before calling any EMC2305 function:</p>
<ul>
<li>FreeRTOS scheduler <strong>must be running</strong></li>
<li>The STM32 <strong>I2C peripheral must be initialized</strong></li>
<li>I2C interrupts <strong>must be enabled</strong></li>
</ul>
<hr />
<h3 id="required-hal-callbacks">Required HAL Callbacks</h3>
<p>You <strong>must</strong> forward these HAL callbacks:</p>
<pre><code class="language-c">void HAL_I2C_MasterTxCpltCallback(I2C_HandleTypeDef *hi2c) {
    EMC2305_I2C_MasterTxCpltCallback(hi2c);
}

void HAL_I2C_MasterRxCpltCallback(I2C_HandleTypeDef *hi2c) {
    EMC2305_I2C_MasterRxCpltCallback(hi2c);
}
</code></pre>
<p>Without this, <strong>all I2C operations will hang</strong>.</p>
<hr />
<h3 id="driver-initialization">Driver Initialization</h3>
<p>The first thing you need to do is initialize the chip using this function. It may only be called from one RTOS task (recommended to do this in your init task). An example using I2C bus 1 and the default chip address (0x4D):</p>
<pre><code class="language-c">EMC2305_HandleTypeDef chip;

EMC2305_Init(&amp;chip, &amp;hi2c1, 0x4D);
</code></pre>
<p>What this does internally:</p>
<ul>
<li>Stores the HAL I2C handle</li>
<li>Converts the 7‑bit address to HAL format (<code>&lt;&lt; 1</code>)</li>
<li>Creates RTOS objects</li>
<li>Spawns the I2C worker task</li>
<li>Associates the chip with a specific I2C instance</li>
<li>
<p>Verifies:</p>
</li>
<li>
<p>Product ID (<code>PID == 0b00</code>)</p>
</li>
<li>Manufacturer ID (<code>0x5D</code>)</li>
</ul>
<p>If <strong>any step fails</strong>, <code>EMC2305_ERR</code> is returned.</p>
<hr />
<h2 id="core-configuration-functions">Core Configuration Functions</h2>
<h3 id="global-chip-configuration">Global Chip Configuration</h3>
<pre><code class="language-c">EMC2305_Global_Config cfg = {
    .alert_mask = false,
    .disable_smbus_timeout = true,
    .watchdog_enable = false,
    .drive_ext_clk = false,
    .use_ext_clk = false,
};

EMC2305_SetGlobalConfig(&amp;chip, &amp;cfg);
</code></pre>
<p>Controls global chip behavior.</p>
<hr />
<h3 id="software-lock-optional">Software Lock (Optional)</h3>
<pre><code class="language-c">EMC2305_EnableSWLock(&amp;chip);
</code></pre>
<ul>
<li>Makes all <strong>SWL registers read‑only</strong></li>
<li>Lock persists until <strong>power cycle</strong></li>
<li>Use only after configuration is complete</li>
<li>Do not use this unless you are very confident in your settings</li>
</ul>
<hr />
<h2 id="operating-modes">Operating Modes</h2>
<h3 id="openloop-pwm-mode-simple">Open‑Loop PWM Mode (Simple)</h3>
<p><strong>When to use:</strong></p>
<ul>
<li>You just want to set a duty cycle</li>
<li>Fan tach feedback is unavailable or unnecessary</li>
</ul>
<p><strong>Required configuration:</strong></p>
<ul>
<li><code>enable_closed_loop = false</code></li>
</ul>
<p><strong>Control function:</strong></p>
<p>Example to set Fan 1 PWM output to 60%:</p>
<pre><code class="language-c">EMC2305_SetFanPWM(&amp;chip, EMC2305_FAN1, 60);
</code></pre>
<hr />
<h3 id="closedloop-rpm-control-recommended">Closed‑Loop RPM Control (Recommended)</h3>
<p><strong>When to use:</strong></p>
<ul>
<li>You need stable RPM across voltage/temperature changes</li>
<li>You have tach feedback connected</li>
</ul>
<p><strong>Required configuration:</strong></p>
<pre><code class="language-c">EMC2305_Fan_Config1 cfg1 = {
    .enable_closed_loop = true,
    .range = EMC2305_RNG_2000,
    .edges = EMC2305_EDG_5,
    .update_time = EMC2305_UDT_100,
};

EMC2305_Fan_Config2 cfg2 = {
    .enable_ramp_rate_ctl = true,
    .enable_glitch_filter = true,
    .derivative_options = EMC2305_DPT_BOTH,
    .error_window = EMC2305_ERG_200RPM,
};

EMC2305_SetFanConfig(&amp;chip, EMC2305_FAN1, &amp;cfg1, &amp;cfg2);
</code></pre>
<p><strong>Control function:</strong></p>
<pre><code class="language-c">EMC2305_SetFanRPM(&amp;chip, EMC2305_FAN1, 3000);
</code></pre>
<hr />
<h2 id="fan-control-api-summary">Fan Control API Summary</h2>
<table>
<thead>
<tr>
<th>Purpose</th>
<th>Function</th>
</tr>
</thead>
<tbody>
<tr>
<td>Set PWM duty</td>
<td><code>EMC2305_SetFanPWM()</code></td>
</tr>
<tr>
<td>Set RPM target</td>
<td><code>EMC2305_SetFanRPM()</code></td>
</tr>
<tr>
<td>Read RPM</td>
<td><code>EMC2305_GetFanRPM()</code></td>
</tr>
<tr>
<td>Read PWM</td>
<td><code>EMC2305_GetFanPWM()</code></td>
</tr>
<tr>
<td>Read fault status</td>
<td><code>EMC2305_GetFanStatus()</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="common-pitfalls">Common Pitfalls</h2>
<h3 id="using-apis-before-rtos-starts">Using APIs Before RTOS Starts</h3>
<p>❌ <strong>Wrong</strong></p>
<pre><code class="language-c">EMC2305_SetFanPWM(...);
</code></pre>
<p>before <code>vTaskStartScheduler()</code></p>
<p>✔ <strong>Correct</strong></p>
<p>Call all APIs <strong>from tasks only</strong>.</p>
<hr />
<h3 id="missing-hal-i2c-callbacks">Missing HAL I2C Callbacks</h3>
<p>Symptoms:</p>
<ul>
<li>Functions block forever</li>
<li>Timeouts occur</li>
</ul>
<p>Fix:</p>
<ul>
<li>Forward HAL callbacks exactly as shown above</li>
</ul>
<hr />
<h3 id="queue-semaphore-exhaustion">Queue / Semaphore Exhaustion</h3>
<p>If too many tasks call EMC2305 APIs simultaneously:</p>
<ul>
<li><code>EMC2305_ReadReg()</code> returns <code>EMC2305_ERR</code></li>
</ul>
<p>Fix:</p>
<ul>
<li>Increase <code>EMC2305_QUEUE_LENGTH</code></li>
<li>Avoid excessive polling</li>
</ul>
<hr />
<h3 id="wrong-control-mode">Wrong Control Mode</h3>
<p>Calling:</p>
<pre><code class="language-c">EMC2305_SetFanPWM()
</code></pre>
<p>while closed‑loop control is enabled will <strong>not work as expected</strong> (and vice-versa).</p>
<hr />
<h2 id="debugging-guide">Debugging Guide</h2>
<h3 id="chip-not-detected">Chip Not Detected</h3>
<p>Check:</p>
<ul>
<li>I2C address (passed as <strong>7‑bit</strong>, not shifted)</li>
<li>SDA/SCL wiring</li>
<li>Pull‑ups present</li>
</ul>
<hr />
<h3 id="rpm-always-reads-uint16_max">RPM Always Reads UINT16_MAX</h3>
<p>Causes:</p>
<ul>
<li>Invalid fan index</li>
<li>I2C read failure</li>
<li>Tach reading = 0</li>
</ul>
<hr />
<h3 id="fan-status-flags">Fan Status Flags</h3>
<p>Use:</p>
<pre><code class="language-c">EMC2305_Fan_Status status = EMC2305_GetFanStatus(&amp;chip);
</code></pre>
<p>Flags indicate:</p>
<ul>
<li>Watchdog expiration</li>
<li>Spin failure</li>
<li>Stall detection</li>
<li>Drive failure</li>
</ul>
<hr />












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>