
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Software library shared among LHRS embedded systems">
      
      
        <meta name="author" content="LHR - Solar">
      
      
      
        <link rel="prev" href="../Installation/">
      
      
        <link rel="next" href="../SharepointSubmodule/">
      
      
      <link rel="icon" href="../LHRs.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Flashing and Debugging - Embedded Sharepoint Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#flashing-and-debugging-on-an-mcu" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Embedded Sharepoint Documentation" class="md-header__button md-logo" aria-label="Embedded Sharepoint Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Embedded Sharepoint Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Flashing and Debugging
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Embedded Sharepoint Documentation" class="md-nav__button md-logo" aria-label="Embedded Sharepoint Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Embedded Sharepoint Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Flashing and Debugging
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Flashing and Debugging
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#attaching-usb-devices-in-wsl" class="md-nav__link">
    <span class="md-ellipsis">
      Attaching USB devices in WSL
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attach-usb-devices-using-usbipd-extension" class="md-nav__link">
    <span class="md-ellipsis">
      Attach USB devices using USBIPD extension
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hardware-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Hardware Interface
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hardware Interface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swd-setup" class="md-nav__link">
    <span class="md-ellipsis">
      SWD Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SWD Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#st-link-connector" class="md-nav__link">
    <span class="md-ellipsis">
      ST-Link Connector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swd-connector" class="md-nav__link">
    <span class="md-ellipsis">
      SWD Connector
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uart-setup" class="md-nav__link">
    <span class="md-ellipsis">
      UART Setup
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#software-tooling" class="md-nav__link">
    <span class="md-ellipsis">
      Software Tooling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Software Tooling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-executables" class="md-nav__link">
    <span class="md-ellipsis">
      Make Executables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flash" class="md-nav__link">
    <span class="md-ellipsis">
      Flash
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debug" class="md-nav__link">
    <span class="md-ellipsis">
      Debug
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debug">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gdb" class="md-nav__link">
    <span class="md-ellipsis">
      GDB
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serial-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Serial Monitoring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../SharepointSubmodule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Adding Embedded Sharepoint
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../CubeMX/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CubeMX
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../STM32_Ports/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    STM32 Ports
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    CAN Messages
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            CAN Messages
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dbcEditor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Workflow
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../DBC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Signals & Messages
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Drivers
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Drivers
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../EMC2305/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    EMC2305 Fan Controller
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#attaching-usb-devices-in-wsl" class="md-nav__link">
    <span class="md-ellipsis">
      Attaching USB devices in WSL
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#attach-usb-devices-using-usbipd-extension" class="md-nav__link">
    <span class="md-ellipsis">
      Attach USB devices using USBIPD extension
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hardware-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Hardware Interface
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hardware Interface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#swd-setup" class="md-nav__link">
    <span class="md-ellipsis">
      SWD Setup
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SWD Setup">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#st-link-connector" class="md-nav__link">
    <span class="md-ellipsis">
      ST-Link Connector
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#swd-connector" class="md-nav__link">
    <span class="md-ellipsis">
      SWD Connector
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#uart-setup" class="md-nav__link">
    <span class="md-ellipsis">
      UART Setup
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#software-tooling" class="md-nav__link">
    <span class="md-ellipsis">
      Software Tooling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Software Tooling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementation" class="md-nav__link">
    <span class="md-ellipsis">
      Implementation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#make-executables" class="md-nav__link">
    <span class="md-ellipsis">
      Make Executables
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#flash" class="md-nav__link">
    <span class="md-ellipsis">
      Flash
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#debug" class="md-nav__link">
    <span class="md-ellipsis">
      Debug
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Debug">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gdb" class="md-nav__link">
    <span class="md-ellipsis">
      GDB
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#serial-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Serial Monitoring
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="flashing-and-debugging-on-an-mcu">Flashing and Debugging on an MCU</h1>
<p>This page will walk you through how you can flash your C code on an MCU using Embedded Sharepoint!</p>
<p>... and also debug it ü´†</p>
<blockquote>
<p>‚ÑπÔ∏è <strong>Prerequisite :</strong> 
Make sure you've <a href="../SharepointSubmodule/">added Embedded Sharepoint</a>.</p>
</blockquote>
<h2 id="attaching-usb-devices-in-wsl">Attaching USB devices in WSL</h2>
<p>When you plug in your STM32 device, it won't automatically get recognized by your WSL</p>
<p>To attach a USB device on WSL you need to install <a href="https://github.com/dorssel/usbipd-win/releases"><code>usbipd-win</code></a>.</p>
<ol>
<li>Install WinGet if you haven't already using these <a href="https://learn.microsoft.com/en-us/windows/package-manager/winget/">instructions</a></li>
<li>Open your powershell in administrator mode</li>
<li>Run <code>winget install --interactive --exact dorssel.usbipd-win</code></li>
</ol>
<p>Once we have <code>usbipd</code> we can bind and attach USB devices.</p>
<ol>
<li>Open Powershell and <strong>"Run as Administrator"</strong>.</li>
<li>Run <code>usbipd list</code> to get a list of all USB buses.</li>
<li>Locate the device called "<strong>ST-Link Debug</strong>" and note the <strong>"BUSID"</strong> (usually in the format of number-number ).</li>
<li>Run <code>usbipd bind --busid &lt;BUSID&gt;</code>.</li>
<li>Run <code>usbipd attach --wsl --busid &lt;BUSID&gt;</code> (<strong>must have an instance of WSL running</strong>).</li>
</ol>
<p>And you're good!</p>
<p>Confirm that your device is shared to WSL by running <code>lsusb</code> in your WSL terminal.  </p>
<h2 id="attach-usb-devices-using-usbipd-extension">Attach USB devices using USBIPD extension</h2>
<p>If you're using VSCode then you can use the <code>USBIPD Connect</code> extension to streamline the process.</p>
<p>Once the extension is installed you should see an <code>Attach</code> button at the bottom of your VSCode that when pressed will show you all USB devices. You can now press the ST-Link USB device to connect to it. </p>
<p>Note: The extension only works with ST-Links/Nucleos that you‚Äôve previously connected. If you want to use a new device, you‚Äôll need to go through the full manual usbipd setup first. Once a device has been connected manually, the extension can be used to reconnect it quickly in the future.</p>
<h2 id="hardware-interface">Hardware Interface</h2>
<p>There are two main methods for programming the STM32 microcontrollers we use on our boards: <strong>Serial Wire Debug</strong> (SWD) and <strong>UART</strong>. SWD is available on any board with a 4-pin programming header. UART requires a USB-UART conversion chip, along with a USB-C port, which can be found on the PSOM and LSOM, for example.</p>
<h3 id="swd-setup">SWD Setup</h3>
<p>SWD is a two-wire protocol that is an alternative to JTAG. JTAG is the most common interface for debugging/accessing MCU registers, but it requires 4 pins to communicate while SWD only requires 2, so many ARM microcontrollers will use SWD to ease pin requirements.</p>
<p>To program the STM32 microcontroller with SWD, we use an <strong>ST-Link</strong>‚Äîa tool from STMicroelectronics that runs dedicated firmware designed to program STM32 devices.</p>
<p>If you take a look at your STM32 Nucleo you should notice <strong>two</strong> sections on the board:</p>
<p><img alt="Nucleo Section" src="../assets/NucleoDivide.png" /></p>
<div style="display: flex; justify-content: space-between;">
    <span><span style="color: #e06666; font-weight: bold;">Red</span> ST-Link for Debugging</span>
    <span><span style="color: #4a90e2; font-weight: bold;">Blue</span> STM32 MCU and Peripherals</span>
</div>

<h4 id="st-link-connector">ST-Link Connector</h4>
<p>Your board may have the jumpers ON or OFF on the ST-Link Connector (<strong>CN2</strong>).</p>
<p><strong>ON</strong> - you are programming the <strong>INTERNAL</strong> STM32 MCU (Nucleo)</p>
<p><strong>OFF</strong> - you are programming the <strong>EXTERNAL</strong> STM32 MCU (Solar Board)</p>
<p>Decide whether you need jumpers based on which MCU you are trying to program.</p>
<blockquote>
<p>‚ÑπÔ∏è If you're unsure, run <code>st-info --probe</code> to see the MCU you're flashing to.</p>
</blockquote>
<h4 id="swd-connector">SWD Connector</h4>
<p>When programming an <strong>external</strong> MCU (not on the Nucleo) the 6-pin SWD connector (CN4) on the ST-Link will be used. </p>
<p>Here's the pinout for reference</p>
<table>
<thead>
<tr>
<th>Pin</th>
<th>CN4</th>
<th>Designation</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>VDD_TARGET</td>
<td>VDD from application</td>
</tr>
<tr>
<td>2</td>
<td>SWCLK</td>
<td>SWD clock</td>
</tr>
<tr>
<td>3</td>
<td>GND</td>
<td>Ground</td>
</tr>
<tr>
<td>4</td>
<td>SWDIO</td>
<td>SWD data I/O</td>
</tr>
<tr>
<td>5</td>
<td>NRST</td>
<td>RESET of target STM32</td>
</tr>
<tr>
<td>6</td>
<td>SWO</td>
<td>Reserved</td>
</tr>
</tbody>
</table>
<p>On our solar boards we have a SWD interface that looks like this</p>
<div style="display: flex; align-items: center; gap: 20px;">
    <img src="../assets/SWDSolarBoard.png" alt="Solar SWD 1" style="height: 200px; width: 200px; object-fit: contain;">
    <img src="../assets/AnothaOne.png" alt="Solar SWD 2" style="height: 200px; width: 200px; transform: rotate(90deg); object-fit: contain;">
</div>

<p>After connecting the corresponding pins you'll be able to program the MCU on your board.</p>
<h3 id="uart-setup">UART Setup</h3>
<p>UART is the simplest way to program our boards, only requiring a USB-C cable to connect to your laptop. However, while it does allow for flashing and serial monitoring using <code>printf</code>, it does not allow you to run OpenOCD and GDB to step through your code.</p>
<p>To connect to your board over UART, plug in a USB-C data cable to the board and your computer. Verify that the board powers up (LEDs turn on) and that you can see the USB-UART chip as a COM port in Device Manager (Windows) or using <code>lsusb_mac</code>/<code>lsusb</code> (MacOS/Linux). On WSL, use <code>usbipd</code> to bind and attach the board the same way you would for ST-Link.</p>
<p><img alt="Device Manager showing CP210x COM port" src="../assets/CP210X_DeviceManager.png" /></p>
<p>When programming over UART, you'll have to use the Boot switch and Reset button on the board (PSOM shown below) to enter and exit the bootloader (special section of code that can erase/write to flash memory). When the Boot switch is set to USR, the MCU will start executing your flashed code whenever the Reset button is pressed. When the Boot switch is set to EXT, the MCU will enter the bootloader and wait for any of its peripherals to receive an erase/flash command. In this case, the command will come over UART from the USB-UART converter, but it can also come from CAN, SPI, or several other interfaces.</p>
<p><img alt="Boot/Reset switches shown on the PSOM" src="../assets/PSOM_RST_BOOT.png" /></p>
<h2 id="software-tooling">Software Tooling</h2>
<h3 id="overview">Overview</h3>
<p>The OpenOCD and stlink packages are some software tools we use to flash and debug code on our board. They are two different options for doing the same thing (flashing and debugging via JTAG/SWD).</p>
<ul>
<li>
<p><a href="https://github.com/stlink-org/stlink"><strong>stlink</strong></a> is a software package developed by STMicroelectronics to interface with an ST-LINK device for programming and debugging purposes.</p>
</li>
<li>
<p><a href="https://pfeerick.github.io/InfiniTime/doc/openOCD.html"><strong>OpenOCD</strong></a> runs a GDB server, which allows us to debug remote targets via GDB. It also lets us write to flash with some extra configuration.</p>
</li>
</ul>
<p>We currently use the OpenOCD GDB server for debugging while using <code>st-flash</code>, a tool in the stlink package for flashing code.</p>
<h3 id="implementation">Implementation</h3>
<p>Embedded Sharepoint contains Makefiles to simplify the process of flashing code on an MCU. These Makefiles directly call the <code>st-flash</code> command.</p>
<p>On an STM32 MCU, flash memory starts at <code>0x8000000</code>.</p>
<p><img alt="0x8000" src="../assets/0x8000.png" /></p>
<p>After the Makefile compiles your source code into a binary (<code>.bin</code>), it writes to flash using</p>
<pre> st-flash write $(BUILD_DIR)/$(TARGET).bin 0x8000000 </pre>

<p><strong>NOTE</strong>: We're not flashing the <code>.elf</code> file because it contains unnecessary debug symbols that we don't need to simply flash.</p>
<h3 id="make-executables">Make Executables</h3>
<p>You can use the Makefile from the <code>test/</code> directory to flash files within the <code>tests/</code> directory.</p>
<ol>
<li>
<p>Navigate to the <code>test/</code> directory.</p>
</li>
<li>
<p>If you've set the environment variables mentioned in "<a href="../SharepointSubmodule/">Adding Embedded Sharepoint</a>" then you can run <code>make TEST=&lt;testfile&gt;</code> where <code>tests/testfile.c</code> is your test.</p>
</li>
<li>
<p>After your code has been compiled and linked you should see information regarding the <code>.elf</code> file created.</p>
</li>
</ol>
<p><img alt="Will Ferrell" src="../assets/ELF.png" /></p>
<p>If you don't see a similar message nor a <code>.elf</code> file in the <code>build/</code> directory, then look at your console output for a specific error traceback.</p>
<h3 id="flash">Flash</h3>
<p>If you ran the previous section without error then you should have a <code>.bin</code> and a <code>.elf</code> in your <code>build/</code> corresponding to your target MCU.</p>
<p>To flash with SWD:</p>
<ol>
<li>Navigate to <code>test/</code></li>
<li>Run <code>make flash</code></li>
</ol>
<p>Or alternatively with UART:</p>
<ol>
<li>Navigate to <code>test/</code></li>
<li>Flip the boot switch to EXT &amp; press reset</li>
<li>Run <code>make flash-uart</code></li>
<li>Flip the boot switch to USR &amp; press reset</li>
</ol>
<p>... and you've flashed to the MCU!</p>
<h3 id="debug">Debug</h3>
<h4 id="gdb">GDB</h4>
<p>To debug we'll use <strong>OpenOCD</strong>. </p>
<ol>
<li>Navigate to the root directory of Embedded Sharepoint.</li>
<li>Run <code>openocd -f openocd-stm32f4x.cfg</code> if you're programming an F4 MCU or the corresponding <code>..l4x.cfg</code> if you're programming an L4.</li>
<li>You should see a message that a GDB server was started on port <code>3333</code>.</li>
</ol>
<p>Open a second terminal session to use GDB</p>
<ol>
<li>Run <code>gdb-multiarch build/(TARGET).elf</code>. If you aren't in root the filepath will look slightly different. On mac you need to do <code>arm-none-eabi-gdb</code> instead of 'gdb'</li>
<li>Verify that GDB is using the debug symbols from the <code>.elf</code> file.</li>
<li>Run <code>tar extended-remote :3333</code> to connect to the OpenOCD GDB server.</li>
</ol>
<p>Step through your code in GDB to analyze execution!</p>
<h4 id="serial-monitoring">Serial Monitoring</h4>
<p>Another debugging option is serial monitoring. The <code>printf</code> method is integrated into Embedded-Sharepoint.</p>
<ol>
<li>
<p>The <code>HAL_UART_MspGPIOInit()</code> function must be implemented with the proper GPIO initialization (RCC_CLK_ENABLE, GPIO struct filled in, HAL_GPIO_Init called).</p>
</li>
<li>
<p>The <code>UART_HandleTypeDef</code> struct must be initialized with the proper settings before calling printf_init.</p>
</li>
<li>
<p>Run <code>printf_init(UART_HandleTypeDef)</code> with your desired UART to output to. For a Nucleo, this will be specified in the Nucleo user manual which you can find online. For one of our PCBs, check the schematic to see which UART peripheral your USB is connected to. </p>
</li>
<li>
<p><code>printf_init</code> must be run after the RTOS is initialized.</p>
</li>
<li>
<p>Run <code>printf(...)</code> with your desired <a href="https://www.geeksforgeeks.org/c/printf-in-c/">format</a>!</p>
</li>
</ol>
<p>To view the output, open up an application like <a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html">PuTTY</a> or <a href="https://github.com/npat-efault/picocom">picocom</a>.</p>
<ul>
<li>For PuTTY, click Serial and enter your desired COM port. This should show up on your device manager (for Mac or Linux, run <code>lsusb</code>). Set the baud rate to what you configured the UART for. Hit the big open button at the bottom.</li>
<li>For picocom, type in <code>picocom -b &lt;baud-rate&gt; &lt;tty-name&gt;</code> and you should be set.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>