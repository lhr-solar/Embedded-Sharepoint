
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Software library shared among LHRS embedded systems">
      
      
        <meta name="author" content="LHR - Solar">
      
      
      
      
      
        
      
      
      <link rel="icon" href="../../LHRs.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>File EMC2305.h - Embedded Sharepoint Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#file-emc2305h" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Embedded Sharepoint Documentation" class="md-header__button md-logo" aria-label="Embedded Sharepoint Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Embedded Sharepoint Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              File EMC2305.h
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Embedded Sharepoint Documentation" class="md-nav__button md-logo" aria-label="Embedded Sharepoint Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Embedded Sharepoint Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    README
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../FlashAndTheBug/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Flashing and Debugging
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../SharepointSubmodule/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Adding Embedded Sharepoint
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CubeMX/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CubeMX
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../STM32_Ports/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    STM32 Ports
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    CAN Messages
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    CAN Messages
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dbcEditor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Editing DBC Files
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DBC/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Signals & Messages
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Drivers Documentation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Drivers Documentation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../EMC2305/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EMC2305 Usage Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../EMC2305_8h/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    EMC2305
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../SevenSegment_8h/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SevenSegment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../printf_8h/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    printf
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    BSP Documentation
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    BSP Documentation
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../BSP/ADC_8h/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ADC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../BSP/CAN_8h/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CAN
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../BSP/UART_8h/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    UART
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="file-emc2305h">File EMC2305.h</h1>
<p><a href="../files/"><strong>File List</strong></a> <strong>&gt;</strong> <a href="../dir_1284b95147afa48b330f502c8bbc0529/"><strong>driver</strong></a> <strong>&gt;</strong> <a href="../dir_63ffe06a04b97e03324a2ad2f10a5002/"><strong>Inc</strong></a> <strong>&gt;</strong> <a href="../EMC2305_8h/"><strong>EMC2305.h</strong></a></p>
<p><a href="../EMC2305_8h/">Go to the documentation of this file</a></p>
<pre><code class="language-C++">// Driver for Microchip EMC2305 PWM Fan Controller

#pragma once

#include &lt;stdint.h&gt;

#include &quot;stm32xx_hal.h&quot;
#include &quot;FreeRTOS.h&quot;

// Device handle
typedef struct {
    I2C_HandleTypeDef* hi2c;        // STM32 HAL I2C handle
    uint16_t dev_addr;              // HAL convention: 7-bit address &lt;&lt; 1
    SemaphoreHandle_t i2c_complete; // Semaphore to signal I2C transaction complete
} EMC2305_HandleTypeDef;

// I2C Response Timeout
#ifndef EMC2305_I2C_TIMEOUT
#define EMC2305_I2C_TIMEOUT 100u // 100ms default
#endif

// I2C Operation Types
typedef enum {
    EMC2305_OP_WRITE,
    EMC2305_OP_READ
} EMC2305_I2C_OP;

// I2C Message Struct
typedef struct {
    EMC2305_HandleTypeDef* chip;    // Chip to send to
    EMC2305_I2C_OP operation;       // Read/Write operation
    uint8_t reg_addr;               // Register address
    uint8_t write_data;             // Data to write (only used for write operations)
    uint8_t* read_data;             // Pointer for storing read data (only used for read operations)
    uint8_t semaphore_index;        // Index of semaphore handle in pool
} EMC2305_I2C_Message;

#ifndef EMC2305_QUEUE_LENGTH
#define EMC2305_QUEUE_LENGTH 10                             // Message queue length
#endif

#define EMC2305_QUEUE_ITEM_SIZE sizeof(EMC2305_I2C_Message) // Size of queue item (message)
#define EMC2305_SEMAPHORE_POOL_SIZE EMC2305_QUEUE_LENGTH    // Number of caller semaphores (max concurrent I2C requests)

// Device status
typedef enum {
    EMC2305_OK,
    EMC2305_ERR,
} EMC2305_Status;

// Device configuration
typedef struct {
    bool alert_mask;                // Blocks the alert pin from being asserted
    bool disable_smbus_timeout;     // Disables the SMBus Time-Out function for the SMBus client (if enabled)
    bool watchdog_enable;           // Enables the Watchdog Timer (see Section 4.11 “Watchdog Timer”) to operate in Continuous Mode
    bool drive_ext_clk;             // Enables the internal tachometer clock to be driven out on the CLK pin so that multiple devices can be synced to the same source
    bool use_ext_clk;               // Enables the device to use a clock present on the CLK pin as the tachometer clock. If the DR_EXT_CLK bit is set, then this bit is ignored and the device will use the internal oscillator.
} EMC2305_Global_Config;

// Fans
typedef enum {
    EMC2305_FAN1,
    EMC2305_FAN2,
    EMC2305_FAN3,
    EMC2305_FAN4,
    EMC2305_FAN5,
} EMC2305_Fan;

// PWM Base Frequency
typedef enum {
    EMC2305_PWM_2k441 = 0b11, // 2.441 kHz
    EMC2305_PWM_4k882 = 0b10, // 4.882 kHz
    EMC2305_PWM_19k53 = 0b01, // 19.53 kHz
    EMC2305_PWM_26k00 = 0b00, // 26.00 kHz
} EMC2305_PWM_BaseFreq;

// Range - Sets the minimum fan speed measured and reported
typedef enum {
    EMC2305_RNG_4000 = 0b11, // 4000 RPM minimum, TACH count multiplier = 8
    EMC2305_RNG_2000 = 0b10, // 2000 RPM minimum, TACH count multiplier = 4
    EMC2305_RNG_1000 = 0b01, // 1000 RPM minimum, TACH count multiplier = 2
    EMC2305_RNG_500 = 0b00,  // 500 RPM minimum, TACH count multiplier = 1
} EMC2305_RNG;

// Edges - Sets the number of edges to sample when calculating RPM
typedef enum {
    EMC2305_EDG_9 = 0b11, // 9 edges sampled (4 poles) - effective Tach multiplier is 2, based on two pole fans
    EMC2305_EDG_7 = 0b10, // 7 edges sampled (3 poles) - effective Tach multiplier is 1.5, based on two pole fans
    EMC2305_EDG_5 = 0b01, // 5 edges sampled (2 poles) - effective Tach multiplier is 1, based on two pole fans
    EMC2305_EDG_3 = 0b00, // 3 edges sampled (1 pole) - effective Tach multiplier is 0.5, based on two pole fans
} EMC2305_EDG;

// Update Time - Sets the PID update rate for closed loop control
typedef enum {
    EMC2305_UDT_100 = 0b000,  // 100 ms update interval
    EMC2305_UDT_200 = 0b001,  // 200 ms update interval
    EMC2305_UDT_300 = 0b010,  // 300 ms update interval
    EMC2305_UDT_400 = 0b011,  // 400 ms update interval
    EMC2305_UDT_500 = 0b100,  // 500 ms update interval
    EMC2305_UDT_800 = 0b101,  // 800 ms update interval
    EMC2305_UDT_1200 = 0b110,  // 1200 ms update interval
    EMC2305_UDT_1600 = 0b111,  // 1600 ms update interval
} EMC2305_UDT;

// Fan Configuration 1
typedef struct {
    bool enable_closed_loop;
    EMC2305_RNG range;
    EMC2305_EDG edges;
    EMC2305_UDT update_time;
} EMC2305_Fan_Config1;

// Derivative Options - Selects form of derivative used in PID
typedef enum {
    EMC2305_DPT_NONE = 0b00,  // No derivative term
    EMC2305_DPT_BASIC = 0b01, // Basic derivative
    EMC2305_DPT_STEP = 0b10,  // Step derivative
    EMC2305_DPT_BOTH = 0b11,  // Both basic + step
} EMC2305_DPT;

// Error Window - Acceptable RPM deviation around target
typedef enum {
    EMC2305_ERG_0RPM = 0b00,   // 0 RPM window
    EMC2305_ERG_50RPM = 0b01,  // ±50 RPM
    EMC2305_ERG_100RPM = 0b10, // ±100 RPM
    EMC2305_ERG_200RPM = 0b11, // ±200 RPM
} EMC2305_ERG;

// Fan Configuration 2
typedef struct {
    bool enable_ramp_rate_ctl;
    bool enable_glitch_filter;
    EMC2305_DPT derivative_options;
    EMC2305_ERG error_window;
} EMC2305_Fan_Config2;

typedef enum {
    EMC2305_PID_8X = 0b11, // 8x gain
    EMC2305_PID_4X = 0b10, // 4x gain
    EMC2305_PID_2X = 0b01, // 2x gain
    EMC2305_PID_1X = 0b00, // 1x gain
} EMC2305_PID_Gain;

typedef struct {
    bool watchdog_fired; // Indicates that the Watchdog Timer has expired. When this bit is set, each fan is driven to 100% duty cycle and will remain at 100% duty cycle until they are programmed. This bit is cleared when it is read.
    bool drive_failed;   // Indicates that one or more fan drivers cannot meet the programmed fan speed at maximum PWM duty cycle.
    bool spin_failed;    // Indicates that one or more fan drivers cannot spin up.
    bool stalled;        // Indicates that one or more fan drivers have stalled.
} EMC2305_Fan_Status;

// Register map from EMC2305 datasheet
// https://ww1.microchip.com/downloads/aemDocuments/documents/MSLD/ProductDocuments/DataSheets/EMC2301-2-3-5-Data-Sheet-DS20006532A.pdf

// Device Configuration
#define EMC2305_REG_CONFIGURATION           0x20u // The Configuration register controls the basic functionality of the EMC2301/2/3/5. The Configuration Register is software locked.
#define EMC2305_REG_FAN_INTERRUPT_ENABLE    0x29u // The Fan Interrupt Enable register controls the masking for each fan channel. When a channel is enabled, it will cause the ALERT pin to be asserted when an Error condition is detected. • ‘1’ - An Error condition (Stall, Spin Up, Drive Fail) on fan X will cause the ALERT pin to be asserted. • ‘0’ (default) - An Error condition on fan X will not cause the ALERT pin to be asserted; however, the status registers will be updated normally.
#define EMC2305_REG_PWM_POLARITY            0x2Au // The PWM Polarity Configuration registers control the output type and polarity of all PWM outputs.
#define EMC2305_REG_PWM_OUTPUT_CONFIG       0x2Bu // The PWM Output Configuration register controls the PWM output type as push-pull or open drain.
#define EMC2305_REG_PWM_BASEF45             0x2Cu // The PWM BASEF45 Register controls the base frequency of PWM drivers 4 and 5.
#define EMC2305_REG_PWM_BASEF123            0x2Du // The PWM BaseF123 Register controls the base frequency of PWM drivers 1, 2 and 3.
#define EMC2305_REG_SW_LOCK                 0xEFu // Software Lock Register - bit 0 LOCK Enables the SWL function: 1 = All SWL registers are locked and read-only. Unlock occurs on power cycle. 0 = All SWL registers are writable.
#define EMC2305_REG_PRODUCT_FEAT            0xFCu // Product Features Register - bit 5-3: ADR[2:0]: SMBus address determined by the ADDR_SEL pin decode. bit 2-0:  FSP[2:0]: Default Fan Speed determined by the CLK pin decode. This is conditional on ADDR_SEL.
#define EMC2305_REG_PRODUCT_ID              0xFDu // Production Identification Register - bit 1-0: PID[1:0]: Product Identification Register. Device defines bit pattern. 00 for EMC2305
#define EMC2305_REG_MANUFACTURER_ID         0xFEu // Manufacturer Identification Register - Hard coded fixed value of 0x5D
#define EMC2305_REG_REVISION                0xFFu // Silicon Revision Register - Hard coded fixed value of 0x80

// Device Status
#define EMC2305_REG_FAN_STATUS              0x24u // The Fan Status register indicates that the fan driver has stalled or failed or that the Watchdog Timer has expired (see Section 4.11 “Watchdog Timer”).
#define EMC2305_REG_FAN_STALL_STATUS        0x25u // The Fan Stall Status register indicates which fan driver has detected a stalled condition (see Section 4.4.3 “Stalled Fan”). All bits are cleared upon a read if the Error condition has been removed.
#define EMC2305_REG_FAN_SPIN_STATUS         0x26u // The Fan Spin Status register indicates which fan driver has failed to spin-up (see Section 4.8 “Spin Up Rou tine”). All bits are cleared upon a read if the Error condition has been removed.
#define EMC2305_REG_DRIVE_FAIL_STATUS       0x27u // The Fan Drive Fail Status register indicates which fan driver cannot drive to the programmed speed even at 100% duty cycle (see Section 4.4.4 “Aging Fan or Invalid Drive Detection” and Register 6-16). All bits are cleared upon a read if the Error condition has been removed.

// Fan 1 Registers (base registers for all fans)
#define EMC2305_REG_FAN1_SETTING            0x30u // Fan 1 Drive Setting Register - The Fan Drive Setting register always displays the current setting of the respective fan driver
#define EMC2305_REG_PWM1_DIVIDE             0x31u // Fan 1 PWM Divide Register - The PWM Divide registers determine the final frequency of the respective PWM Fan Driver. Each driver base frequency is divided by the value of the respective PWM Divide Register to determine the final frequency.
#define EMC2305_REG_FAN1_CONFIG1            0x32u // Fan 1 Configuration Register 1 - The Fan Configuration 1 registers control the general operation of the RPM-based Fan Speed Control algorithm used for the respective Fan Driver (see Section 4.3 “RPM-Based Fan Speed Control Algorithm”).
#define EMC2305_REG_FAN1_CONFIG2            0x33u // Fan 1 Configuration Register 2 - The Fan Configuration 2 registers control the tachometer measurement and advanced features of the RPM based Fan Speed Control algorithm (see Section 4.3 “RPM-Based Fan Speed Control Algorithm”)
#define EMC2305_REG_GAIN1                   0x35u // Fan 1 PID Gain Register - See Section 4.3.3.2 “Setting the PID Gains”.
#define EMC2305_REG_FAN1_SPIN               0x36u // Fan 1 Spin Up Configuration Registers - The Fan Spin Up Configuration registers control the settings of the Spin Up Routine. These registers are software locked (see Section 4.8 “Spin Up Routine”)
#define EMC2305_REG_FAN1_MAX_STEP           0x37u // Fan 1 Maximum Step Size Register - This register determines the maximum step size for the ramp rate control (see Section 4.3.3.3 “Fan Drive Max Step” and Section 4.10 “Ramp Rate Control”).
#define EMC2305_REG_FAN1_MIN_DRIVE          0x38u // Fan 1 Minimum Drive Register - The Fan Minimum Drive Register (see Section 4.3.3.4 “Minimum Drive Setting”) stores the minimum drive setting for each RPM-based Fan Speed Control algorithm.
#define EMC2305_REG_FAN1_VALID_TACH         0x39u // Fan 1 Valid TACH Count Register - The Valid TACH Count registers store the maximum TACH Reading register value to indicate that each fan is spinning properly (see Section 4.4.2 “Valid Tachometer Readings”). 
#define EMC2305_REG_FAN1_DRVFAIL_L          0x3Au // Fan 1 Drive Fail Band Low Byte Register - The Drive Fail Band registers store the number of tach counts used by the Fan Drive Fail detection circuitry.
#define EMC2305_REG_FAN1_DRVFAIL_H          0x3Bu // Fan 1 Drive Fail Band High Byte Register - The Drive Fail Band registers store the number of tach counts used by the Fan Drive Fail detection circuitry.
#define EMC2305_REG_FAN1_TACH_TARGET_L      0x3Cu // Fan 1 Tachometer Closed Loop Target Low Byte Register - The TACH Target Registers hold the target tachometer value that is maintained by the RPM-based Fan Speed Control algorithm.
#define EMC2305_REG_FAN1_TACH_TARGET_H      0x3Du // Fan 1 Tachometer Closed Loop Target High Byte Register - The TACH Target Registers hold the target tachometer value that is maintained by the RPM-based Fan Speed Control algorithm.
#define EMC2305_REG_FAN1_TACH_READING_H     0x3Eu // Fan 1 Tachometer Reading High Byte Register - The TACH Reading Registers describe the current tachometer reading for each of the fans (see Section 4.4 “Tachometer Measurement”). 
#define EMC2305_REG_FAN1_TACH_READING_L     0x3Fu // Fan 1 Tachometer Reading Low Byte Register - The TACH Reading Registers describe the current tachometer reading for each of the fans (see Section 4.4 “Tachometer Measurement”). 

// Address offset per fan register block
#define EMC2305_FAN_ADDRESS_OFFSET         0x10u

#define EMC2305_FAN_REG_ADDR(fan_num, fan1_reg_addr) ((fan1_reg_addr) + ((fan_num) * EMC2305_FAN_ADDRESS_OFFSET))

 // Bitmasks
 // Config (0x20) bits
#define EMC2305_CFG_MASK_ALERT              (1u &lt;&lt; 7)  /* MASK - mask ALERT pin when set */
#define EMC2305_CFG_DIS_TO                  (1u &lt;&lt; 6)  /* DIS_TO - SMBus timeout disable (I2C compat) */
#define EMC2305_CFG_WD_EN                   (1u &lt;&lt; 5)  /* WD_EN - enable watchdog continuous mode */
#define EMC2305_CFG_DRECK                   (1u &lt;&lt; 1)  /* DRECK - CLK pin drives internal clock when set (output) */
#define EMC2305_CFG_USECK                   (1u &lt;&lt; 0)  /* USECK - use external CLK pin as tach clock when set */

// Fan Status (0x24) bits
#define EMC2305_STAT_WATCH                  (1u &lt;&lt; 7)  /* WATCH - watchdog fired (read-to-clear) */
#define EMC2305_STAT_DRVFAIL                (1u &lt;&lt; 2)  /* Drive fail summary */
#define EMC2305_STAT_FNSPIN                 (1u &lt;&lt; 1)  /* spin-up failure summary */
#define EMC2305_STAT_FNSTL                  (1u &lt;&lt; 0)  /* stall summary */

// Bitmasks for Fan 1-5
#define EMC2305_FAN1_MASK                   (1u &lt;&lt; 0)
#define EMC2305_FAN2_MASK                   (1u &lt;&lt; 1)
#define EMC2305_FAN3_MASK                   (1u &lt;&lt; 2)
#define EMC2305_FAN4_MASK                   (1u &lt;&lt; 3)
#define EMC2305_FAN5_MASK                   (1u &lt;&lt; 4)

// Software Lock (0xEF)
#define EMC2305_SWL                         (1u &lt;&lt; 0)

// Bit masks for PWM Base Freq
#define EMC2305_PWM_FAN1_MASK               0x03u
#define EMC2305_PWM_FAN2_MASK               0x0Cu
#define EMC2305_PWM_FAN3_MASK               0x30u
#define EMC2305_PWM_FAN4_MASK               0x03u
#define EMC2305_PWM_FAN5_MASK               0x0Cu

// Bit shifts for PWM Base Freq
#define EMC2305_PWM_FAN1_SHIFT              0u
#define EMC2305_PWM_FAN2_SHIFT              2u
#define EMC2305_PWM_FAN3_SHIFT              4u
#define EMC2305_PWM_FAN4_SHIFT              0u
#define EMC2305_PWM_FAN5_SHIFT              2u

// Bit shifts for fan configuration 1 register
#define EMC2305_CONFIG1_ENAG_SHIFT          7u
#define EMC2305_CONFIG1_RNG_SHIFT           5u
#define EMC2305_CONFIG1_EDG_SHIFT           3u
#define EMC2305_CONFIG1_UDT_SHIFT           0u

// Bit shifts for fan configuration 2 register
#define EMC2305_CONFIG2_ENRC_SHIFT          6u
#define EMC2305_CONFIG2_GHEN_SHIFT          5u
#define EMC2305_CONFIG2_DPT_SHIFT           3u
#define EMC2305_CONFIG2_ERG_SHIFT           1u

// Conversion from RPM to tach counts (Equation 2 in SMSC AN 17.4)
#define EMC2305_TACH_RPM_CONV               3932160u
#define EMC2305_TACH_MULT                   2u

// Minimum RPM to set
#define EMC2305_MIN_RPM                     500
// Maximum RPM to set
#define EMC2305_MAX_RPM                     16000

#define EMC2305_INVALID_FAN(fan_num) (fan &lt; EMC2305_FAN1 || fan &gt; EMC2305_FAN5)

// Device Management Functions

EMC2305_Status EMC2305_Init(EMC2305_HandleTypeDef* chip, I2C_HandleTypeDef* hi2c, uint16_t dev_addr);

EMC2305_Status EMC2305_EnableSWLock(EMC2305_HandleTypeDef* chip);

EMC2305_Status EMC2305_SetGlobalConfig(EMC2305_HandleTypeDef* chip, EMC2305_Global_Config* config);

// Fan Configuration Functions

EMC2305_Status EMC2305_SetPWMBaseFrequency(EMC2305_HandleTypeDef* chip, EMC2305_Fan fan, EMC2305_PWM_BaseFreq freq);

EMC2305_Status EMC2305_SetFanConfig(EMC2305_HandleTypeDef* chip, EMC2305_Fan fan, EMC2305_Fan_Config1* config1, EMC2305_Fan_Config2* config2);

EMC2305_Status EMC2305_SetPWMOutputMode(EMC2305_HandleTypeDef* chip, EMC2305_Fan fan, bool open_drain);

// Fan Control Functions

EMC2305_Status EMC2305_SetFanPWM(EMC2305_HandleTypeDef* chip, EMC2305_Fan fan, uint8_t duty_cycle);

EMC2305_Status EMC2305_SetFanRPM(EMC2305_HandleTypeDef* chip, EMC2305_Fan fan, uint16_t rpm_target);

// Status &amp; Measurement Functions

uint16_t EMC2305_GetFanRPM(EMC2305_HandleTypeDef* chip, EMC2305_Fan fan);

uint8_t EMC2305_GetFanPWM(EMC2305_HandleTypeDef* chip, EMC2305_Fan fan);

EMC2305_Fan_Status EMC2305_GetFanStatus(EMC2305_HandleTypeDef* chip);

// Register Read/Write Functions

EMC2305_Status EMC2305_ReadReg(EMC2305_HandleTypeDef* chip, uint8_t reg, uint8_t* data);

EMC2305_Status EMC2305_WriteReg(EMC2305_HandleTypeDef* chip, uint8_t reg, uint8_t data);

// Worker task to consume messages from the queue and send on I2C bus
void EMC2305_I2C_Worker_Task(void* pvParameters);

// I2C Transmit Interrupt Callback (Internal)
void EMC2305_I2C_MasterTxCpltCallback(I2C_HandleTypeDef* hi2c);

// I2C Receive Interrupt Callback (Internal)
void EMC2305_I2C_MasterRxCpltCallback(I2C_HandleTypeDef* hi2c);
</code></pre>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>